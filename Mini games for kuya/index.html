<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Surprise Ulang Tahun ‚Äî Khlomeratz (Deluxe)</title>
  <style>
    :root{--bg:#287b81;--card:#05383a;--accent:#ff6b6b;--accent2:#ffd166;--text:#f8fafc}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#4d5c68);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--text);display:flex;align-items:center;justify-content:center;min-height:100vh}
    .wrap{width:980px;max-width:96%;background:linear-gradient(180deg,rgba(255, 255, 255, 0.02),rgba(255, 255, 255, 0.06));border-radius:14px;padding:18px;box-shadow:0 18px 40px rgba(2,6,23,0.7)}
    header{display:flex;align-items:center;gap:14px}
    .title{font-size:20px;font-weight:800}
    .sub{font-size:13px;color:rgba(255,255,255,0.75)}

    .game-area{display:flex;gap:18px;margin-top:12px}
    .left{flex:1;background:linear-gradient(180deg,#0ff8b2,#25abb4);border-radius:12px;padding:12px;position:relative;overflow:hidden}
    canvas{background:transparent;display:block;border-radius:8px;width:100%;height:460px}
    .hud{position:absolute;left:18px;top:18px;background:rgba(255, 255, 255, 0.25);padding:8px 12px;border-radius:999px;font-weight:700;display:flex;gap:12px;align-items:center}

    .right{width:320px;max-width:36%;display:flex;flex-direction:column;gap:12px}
    .panel{background:var(--card);padding:12px;border-radius:10px}
    .panel h3{margin:0 0 8px 0}

    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:#041018;padding:10px 12px;border-radius:10px;font-weight:800;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}

    .note{font-size:13px;color:rgba(255,255,255,0.8)}

    /* popup */
    .popup{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:all .25s}
    .popup.show{opacity:1;pointer-events:auto}
    .card{background:linear-gradient(180deg,#fff,#ffe6e6);color:#061018;padding:22px;border-radius:14px;text-align:center;min-width:320px;box-shadow:0 20px 50px rgba(2,6,23,0.6)}

    .confetti{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none}

    footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:rgba(255,255,255,0.7);font-size:13px}

    .top-controls{display:flex;gap:8px;align-items:center}
    input[type=range]{width:100%}

    @media(max-width:760px){.game-area{flex-direction:column}.right{max-width:none;width:100%}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="font-size:40px">üéâ</div>
      <div>
        <div class="title">Selamat Ulang Tahun Ka Kuya ‚Äî <span id="titleName">Khlomeratz</span>‚ù§Ô∏è</div>
      </div>
    </header>

    <div class="game-area">
      <div class="left">
        <div class="hud">
          <div>‚≠ê Score: <span id="score">0</span></div>
          <div>‚è±Ô∏è Time: <span id="time">--</span></div>
          <div>üíì Target: <span id="target">10</span></div>
          <div id="livesEl">üõ°Ô∏è Lives: <span id="lives">3</span></div>
        </div>
        <canvas id="gameCanvas" width="880" height="460"></canvas>
        <canvas class="confetti" id="confettiCanvas"></canvas>

        <div class="popup" id="winPopup">
          <div class="card">
            <div style="font-size:48px">üê¢üéÇ</div>
            <h1 id="winTitle">Selamat Ulang Tahun, Khlomeratz!‚ù§Ô∏è</h1>
            <p id="winMsg">Hadiah kecil dari aku. Semoga tahun ini tahun yang menyenangkan buat kamu ‚ù§Ô∏è</p>
            <p style="margin-top:10px"><strong>Score akhir:</strong> <span id="finalScore">0</span></p>
            <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
              <button class="btn" id="playAgain">Main Lagi</button>
              <button class="btn secondary" id="closePopup">Tutup</button>
            </div>
          </div>
        </div>

        <div class="popup" id="milestonePopup">
          <div class="card" style="min-width:260px">
            <div style="font-size:36px">üíå</div>
            <h2 id="milestoneTitle">Pesan</h2>
            <p id="milestoneText">Anjaiii</p>
            <div style="margin-top:10px"><button class="btn" id="okMilestone">OK</button></div>
          </div>
        </div>
      </div>

      <div class="right">
        <div class="panel">
          <h3>Controls & Start</h3>
          <div class="top-controls">
            <button class="btn" id="startBtn">Mulai</button>
            <button class="btn secondary" id="pauseBtn">Jeda</button>
            <button class="btn secondary" id="muteBtn">Mute</button>
          </div>
          <p class="note">Gunakan panah / WASD untuk bergerak. Hindari obstacle, kumpulkan hati.</p>
        </div>

        <div class="panel">
          <h3>Pengaturan</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px">
          </div>
          <div style="margin-top:8px">Target Score: <input id="targetRange" type="range" min="5" max="40" value="10" /> <strong id="targetLabel">20</strong></div>
          <div style="margin-top:8px">Volume musik: <input id="volRange" type="range" min="0" max="1" step="0.01" value="0.6" /></div>
          <div style="margin-top:8px">Mode: <select id="modeSelect" style="width:100%;padding:8px;border-radius:8px;background:transparent;color:var(--text)"><option value="normal">Normal</option><option value="hard">Hard (lebih banyak obstacle)</option></select></div>
        </div>

        <div class="panel">
          <h3>Tips & Fun</h3>
          <ul style="margin:8px 0 0 16px">
            <li>Setiap 5 hati ada pesan kiyowo yang muncul.</li>
            <li>Jika terkena bola-bola gemoy, kehilangan 1 nyawa.</li>
          </ul>
        </div>
      </div>
    </div>

    <footer>
      <div>Made with ‚ù§ untuk Khlomeratz</div>
      <div style="font-size:12px">Tip: buka di Chrome. Tekan M untuk mute.</div>
    </footer>
  </div>

  <script>
    // --- ELEMENTS ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const confettiCanvas = document.getElementById('confettiCanvas');
    const cctx = confettiCanvas.getContext('2d');

    const scoreEl = document.getElementById('score');
    const timeEl = document.getElementById('time');
    const targetEl = document.getElementById('target');
    const livesEl = document.getElementById('lives');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const muteBtn = document.getElementById('muteBtn');
    const winPopup = document.getElementById('winPopup');
    const finalScore = document.getElementById('finalScore');
    const playAgain = document.getElementById('playAgain');
    const closePopup = document.getElementById('closePopup');
    const nameInput = document.getElementById('nameInput');
    const applyName = document.getElementById('applyName');
    const targetRange = document.getElementById('targetRange');
    const targetLabel = document.getElementById('targetLabel');
    const volRange = document.getElementById('volRange');
    const modeSelect = document.getElementById('modeSelect');
    const titleName = document.getElementById('titleName');
    const milestonePopup = document.getElementById('milestonePopup');
    const milestoneText = document.getElementById('milestoneText');
    const okMilestone = document.getElementById('okMilestone');

    // game state
    let score = 0;
    let target = Number(targetRange.value) || 10;
    let lives = 3;
    let timeLeft = 45; // seconds default
    let running = false;
    let hearts = [];
    let obstacles = [];
    let keys = {};
    let lastSpawn = 0;
    let spawnInterval = 1200; // ms
    let level = 1;
    let levelStart = 0;
    let difficultyMultiplier = 1;

    const player = {x:90,y:220,w:56,h:72,speed:4,dir:0,frame:0,expr:'normal'};

    // audio using WebAudio (no external files)
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioCtx();
    let masterGain = audioCtx.createGain(); masterGain.gain.value = Number(volRange.value); masterGain.connect(audioCtx.destination);
    let musicOsc = null; let musicPlaying = false; let sfxOn = true;

    function playTone(freq,duration, type='sine', gain=0.08){
      if(!sfxOn) return;
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq; g.gain.setValueAtTime(gain, audioCtx.currentTime);
      o.connect(g); g.connect(masterGain); o.start(); o.stop(audioCtx.currentTime + duration);
    }

    function startMusic(){
      if(musicPlaying) return;
      musicPlaying = true;
      // simple looping arpeggio via scheduled tones
      let t=0; const pattern=[440,550,660,880,660,550];
      function schedule(){
        if(!musicPlaying) return;
        for(let i=0;i<pattern.length;i++){
          const when = audioCtx.currentTime + t + i*0.25;
          const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
          o.type='sine'; o.frequency.value = pattern[i]; g.gain.setValueAtTime(0.02,when);
          o.connect(g); g.connect(masterGain); o.start(when); o.stop(when+0.22);
        }
        t += pattern.length*0.25;
        setTimeout(schedule, pattern.length*250);
      }
      schedule();
    }
    function stopMusic(){ musicPlaying=false; }

    volRange.addEventListener('input', ()=>{ masterGain.gain.value = Number(volRange.value); });

    // confetti
    let confettiPieces = [];
    function startConfetti(){ confettiPieces = []; for(let i=0;i<150;i++){ confettiPieces.push({x:Math.random()*confettiCanvas.width, y:-Math.random()*confettiCanvas.height, vx:(Math.random()-0.5)*3, vy:2+Math.random()*5, r:Math.random()*8+2, c: ['#ff7b7b','#ffd166','#79f2c0','#9ad1a6','#c6b7ff'][Math.floor(Math.random()*5)]}); } runConfetti(); }
    let confettiRunning = false;
    function runConfetti(){ confettiRunning = true; cctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height); for(const p of confettiPieces){ p.x += p.vx; p.y += p.vy; p.vy += 0.03; cctx.fillStyle = p.c; cctx.fillRect(p.x,p.y,p.r,p.r*0.6); if(p.y > confettiCanvas.height + 20){ p.y = -10; p.x = Math.random()*confettiCanvas.width; p.vy = 2+Math.random()*4; } } if(confettiRunning) requestAnimationFrame(runConfetti); }
    function stopConfetti(){ confettiRunning = false; cctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height); }

    // drawing helpers
    function drawPlayer(){ ctx.save(); ctx.translate(player.x,player.y);
      // legs animation
      const legOffset = Math.sin(player.frame*0.2)*6;
      ctx.fillStyle = '#133b2b'; ctx.fillRect(-8+legOffset,36,40,14);
      // shell
      ctx.beginPath(); ctx.ellipse(8,8,36,26,0,0,Math.PI*2); ctx.fillStyle='#2e7d5e'; ctx.fill();
      ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=2; ctx.stroke();
      // head
      ctx.beginPath(); ctx.arc(-34,6,22,0,Math.PI*2); ctx.fillStyle='#9ad1a6'; ctx.fill();
      // eyes & expression
      ctx.fillStyle='#061018';
      if(player.expr==='happy'){ ctx.beginPath(); ctx.arc(-38,0,3,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(-28,0,3,0,Math.PI*2); ctx.fill(); }
      else if(player.expr==='hurt'){ ctx.beginPath(); ctx.arc(-38,-2,2,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(-28,-2,2,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.moveTo(-42,8); ctx.lineTo(-24,12); ctx.stroke(); }
      else { ctx.beginPath(); ctx.arc(-38,0,3,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(-28,0,3,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(-28,6,6,0,Math.PI); ctx.stroke(); }
      ctx.restore();
    }

    function drawHeart(h){ ctx.save(); ctx.translate(h.x,h.y); ctx.rotate(h.angle); ctx.beginPath(); const s=h.size/2; ctx.moveTo(0,s/2); ctx.bezierCurveTo(0,-s*0.6,-s,-s*0.1,-s,s/2); ctx.bezierCurveTo(-s,s*1.3,0,s*1.7,0,s*2); ctx.bezierCurveTo(0,s*1.7,s,s*1.3,s,s/2); ctx.bezierCurveTo(s,-s*0.1,0,-s*0.6,0,s/2); ctx.closePath(); ctx.fillStyle='#ff6b6b'; ctx.fill(); ctx.restore(); }

    function drawObstacle(o){ ctx.save(); ctx.translate(o.x,o.y); ctx.fillStyle = o.type==='jelly'? '#6f3b9a' : '#e07a5f'; ctx.beginPath(); ctx.arc(0,0,o.r,0,Math.PI*2); ctx.fill(); if(o.type==='jelly'){ ctx.fillStyle='#fff'; ctx.fillRect(-o.r*0.6,o.r*0.2,o.r*1.2,4); } ctx.restore(); }

    function rectsOverlap(a,b){ return !(a.x+a.w < b.x || a.x > b.x+b.w || a.y+a.h < b.y || a.y > b.y+b.h); }

    // spawn objects
    function spawnHeart(){ const size = 26 + Math.random()*18; const x = 60 + Math.random()*(canvas.width-120); const y = 60 + Math.random()*(canvas.height-120); hearts.push({x,y,size,angle:0}); }
    function spawnObstacle(){ const r = 16 + Math.random()*22; const side = Math.random(); let x = Math.random()*(canvas.width-80)+40; let y = -r; if(Math.random() > 0.6){ x = Math.random() > 0.5? -r : canvas.width + r; y = 60 + Math.random()*(canvas.height-120); }
      const speed = 1.2 + Math.random()*2 * difficultyMultiplier; const type = Math.random()>0.6? 'jelly' : 'rock'; obstacles.push({x,y,r,vx:(canvas.width/2 - x)/200 + (Math.random()-0.5),vy: speed,type}); }

    // game loop
    let last = 0;
    function loop(ts){ if(!running){ last=ts; requestAnimationFrame(loop); return; }
      const dt = ts - last; last = ts;
      // spawn logic
      if(ts - lastSpawn > spawnInterval){ spawnHeart(); if(Math.random() < 0.6) spawnObstacle(); lastSpawn = ts; }

      // update player
      if(keys['ArrowLeft'] || keys['a']) player.x -= player.speed;
      if(keys['ArrowRight'] || keys['d']) player.x += player.speed;
      if(keys['ArrowUp'] || keys['w']) player.y -= player.speed;
      if(keys['ArrowDown'] || keys['s']) player.y += player.speed;
      player.x = Math.max(28, Math.min(canvas.width-28, player.x));
      player.y = Math.max(28, Math.min(canvas.height-28, player.y));
      player.frame++;

      // update hearts
      for(let i=hearts.length-1;i>=0;i--){ hearts[i].angle += 0.03; const hr = {x:hearts[i].x - hearts[i].size/2, y:hearts[i].y - hearts[i].size/2, w:hearts[i].size, h:hearts[i].size}; const pl = {x:player.x-40,y:player.y-20,w:80,h:80}; if(rectsOverlap(hr,pl)){ hearts.splice(i,1); score += 1; scoreEl.textContent = score; playTone(880,0.08,'square',0.08); player.expr='happy'; setTimeout(()=>player.expr='normal',300);
          checkMilestone(); if(score >= target){ endGame(true); } }
      }

      // update obstacles
      for(let i=obstacles.length-1;i>=0;i--){ const o = obstacles[i]; o.x += o.vx; o.y += o.vy; if(o.x < -60 || o.x > canvas.width + 60 || o.y > canvas.height + 60) obstacles.splice(i,1);
        const obb = {x:o.x - o.r, y:o.y - o.r, w:o.r*2, h:o.r*2}; const pl = {x:player.x-40,y:player.y-20,w:80,h:80}; if(rectsOverlap(obb,pl)){ obstacles.splice(i,1); lives -= 1; livesEl.textContent = lives; playTone(120,0.12,'sawtooth',0.12); player.expr='hurt'; setTimeout(()=>player.expr='normal',500); if(lives <= 0) endGame(false); }
      }

      // draw
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // background subtle patterns
      for(let i=0;i<80;i++){ ctx.fillStyle = 'rgba(255,255,255,0.02)'; ctx.fillRect((i*53)%canvas.width, ((i*91)%canvas.height), 1,1); }
      // hearts
      for(const h of hearts) drawHeart(h);
      // obstacles
      for(const o of obstacles) drawObstacle(o);
      // player
      drawPlayer();

      requestAnimationFrame(loop);
    }

    // time & level management
    let timerInterval = null;
    function startTimer(){ clearInterval(timerInterval); timerInterval = setInterval(()=>{
        if(!running) return; timeLeft -= 1; timeEl.textContent = timeLeft + 's'; if(timeLeft <= 0) endGame(false);
      },1000); }

    function levelUp(){ level += 1; difficultyMultiplier += 0.4; spawnInterval = Math.max(600, spawnInterval - 120);
      // reward: extra life
      lives = Math.min(5, lives + 1); livesEl.textContent = lives;
      showMilestone(`Level ${level}!`, `Anjai! keren banget!! yu bisa yu lanjut :)`);
    }

    function checkMilestone(){ if(score > 0 && score % 5 === 0){ const messages = [
        'HAPPY BIRTHDAY KA KUYA <3.',
        'CIE ULTAH.',
        'Love u <3.',
        'Selamat ulang Tahun sayang.'
      ]; showMilestone('jengjeng', messages[(score/5 -1) % messages.length]);
      if(score % 10 === 0) levelUp(); }
    }

    function showMilestone(title,text){ milestonePopup.classList.add('show'); document.getElementById('milestoneTitle').textContent = title; milestoneText.textContent = text; }

    // start/pause/end
    function startGame(){ if(audioCtx.state === 'suspended') audioCtx.resume(); score = 0; lives = 3; timeLeft = 45; hearts = []; obstacles = []; scoreEl.textContent = score; livesEl.textContent = lives; target = Number(targetRange.value); targetEl.textContent = target; running = true; lastSpawn = performance.now(); spawnInterval = 1200; level = 1; difficultyMultiplier = 1; player.x = 90; player.y = 220; startConfetti(); stopConfetti(); // start music
      if(!musicPlaying) startMusic(); last = performance.now(); startTimer(); requestAnimationFrame(loop); }
    function pauseGame(){ running = !running; pauseBtn.textContent = running ? 'Jeda' : 'Lanjutkan'; }
    function endGame(win){ running = false; finalScore.textContent = score; document.getElementById('winTitle').textContent = win ? `Selamat, ${titleName.textContent}!` : 'Waktu Habis / Kehabisan Nyawa'; document.getElementById('winMsg').textContent = win ? 'Kamu berhasil! Semoga hadiah kecil ini bikin senyum di wajahmu ‚ù§Ô∏è' : 'Ups! Nih masih ada kesempatan lagi, coba deh :)'; winPopup.classList.add('show'); if(win){ startConfetti(); playTone(660,0.25,'triangle',0.12); setTimeout(()=>playTone(880,0.32,'sine',0.14),120); } else { playTone(120,0.4,'sawtooth',0.14); stopConfetti(); } clearInterval(timerInterval); }

    // input
    addEventListener('keydown', e=>{ if(e.key==='m' || e.key==='M'){ toggleMute(); } keys[e.key]=true; });
    addEventListener('keyup', e=>{ keys[e.key]=false; });

    startBtn.addEventListener('click', ()=>{ startGame(); });
    pauseBtn.addEventListener('click', ()=>{ pauseGame(); });
    muteBtn.addEventListener('click', ()=>{ toggleMute(); });
    playAgain.addEventListener('click', ()=>{ winPopup.classList.remove('show'); stopConfetti(); startGame(); });
    closePopup.addEventListener('click', ()=>{ winPopup.classList.remove('show'); stopConfetti(); });
    applyName.addEventListener('click', ()=>{ const v = nameInput.value.trim(); if(v){ titleName.textContent = v; document.getElementById('winTitle').textContent = `Selamat, ${v}!`; } nameInput.value=''; });

    targetRange.addEventListener('input', ()=>{ targetLabel.textContent = targetRange.value; });
    targetRange.addEventListener('change', ()=>{ target = Number(targetRange.value); targetEl.textContent = target; });

    okMilestone.addEventListener('click', ()=>{ milestonePopup.classList.remove('show'); });

    volRange.addEventListener('input', ()=>{ masterGain.gain.value = Number(volRange.value); });

    function toggleMute(){ sfxOn = !sfxOn; muteBtn.textContent = sfxOn ? 'Mute' : 'Unmute'; if(!sfxOn) stopMusic(); else startMusic(); }

    // responsive canvas
    function onResize(){ canvas.width = Math.min(880, document.querySelector('.left').clientWidth - 24); canvas.height = 460; confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; }
    addEventListener('resize', onResize); onResize();

    // initial demo spawn
    for(let i=0;i<6;i++) spawnHeart();
  </script>
</body>
</html>
